---
title: "BoskR Tutorial"
author: "[Orlando Schwery](https://oschwery.github.io/)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BoskR Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## 1 Introduction ##
This is a tutorial vignette to provide a quick and easy introduction to the use of BoskR. It will make use of the inbuilt example files and lead through the most important functions of the package.

The purpose of the package BoskR is, to test whether a given diversification model is adequate to analyse an empirical phylogeny with. We can use different models to analyse diversification on a phylogeny, and pick the one that's best supported ( _e.g._ by likelihood or AIC), but that doesn't tell us anything about whether that model is an appropriate one to use in the first place, _i.e._ whether the model is capable of describing the patterns we're analysing at all.

The way BoskR is trying to judge adequacy is by tree shape. The logic behind this is, that if a model cannot produce trees of a shape similar to an empirical tree, it is also not suited to analyse that tree. The package makes use of tree metrics measured from the spectral density of a trees modified graph Laplacian, as calculated in the package `RPANDA`. Details on this can be found in the corresponding publications and manuals [add links to those here].

## 2 Installation ##
### 2.1 CRAN ###
In order to install the stable CRAN version of the package [this is obviously not possible yet]:

```{r, eval=FALSE}
install.packages("BoskR")
```

### 2.2 Development Version from GitHub ###
If you want to install the development version from GitHub, you can do so using the package `devtools`:
```{r, eval=FALSE}
# 1. Install package 'devtools' (if not already installed):
install.packages("devtools")

# 2. Load 'devtools' and permanently or temporarily install and load 'BoskR':
library(devtools)

dev_mode(on=T)  # if you run this line, you launch developer mode, in which case the package will only be installed temporarily.

install_github("oschwery/BoskR")  # install the package from GitHub
library(BoskR)  # load the package

dev_mode(on=F)  # If you used it, leave developers mode after done trying out 'BoskR'
```

## 3 Use ##
When we load the package, all its functions and the other required packages are imported.
```{r, results="hide", warning=FALSE, message=FALSE}
library(BoskR)
```

### 3.1 Load and Prepare Data ###
#### 3.1.1 Example Files ####
The package comes with a set of six empirical example trees to use, which can be loaded using `data` (for the sake of this demonstration, we want to only use the whales tree, so we extract that one).
```{r, results="hide"}
data(emptesttrees)  # load example treeset
emptesttrees <- emptesttrees$Emp_1  # replace it by first tree only
```

#### 3.1.2 Data Format and Own Data ####
The downstream functions expect the input trees to be in a certain format (object of class `multiPhylo`/list of trees). We can use `CombineTrees` to combine any of our own input trees, and the function takes anything from single trees, lists of trees and multiPhylo objects. Here we can use it to make sure our single whale tree is in the right format as well.
```{r, results="hide"}
emptesttrees <- CombineTrees(emptesttrees)
```

#### 3.1.3 Test and Correct Tree Issues ####
The analyses require fully resolved, ultrametric trees, and we can test our tree set for that and automatically correct it. If the a tree is not ultrametric due to rounding errors, and if we are fine to randomly resolve polytomies, we can let `TreeCorr` do that for us, plus reordering all trees to `cladewise`.
```{r}
emptesttrees <- TreeCorr(emptesttrees)
```

### 3.2 Estimate Parameters and Get Shape Metrics ###
With our tree ready, we can move on to the main part of the procedure. We first estimate the diversification parameters from our empirical tree under our model of choice (we'll pick `"BD"` for a constant rate birth-death model for now), and measure the trees shape metrics:
```{r, results="hide"}
emptestparams <- GetTreeParams(emptesttrees, "BD")  # estimate parameters from empirical tree
emptestmetrics <- GetTreeMetrics(emptesttrees, empirical_start=TRUE) # get tree shape metrics from empirical trees
```

### 3.3 Simulate Trees Under Model ###
Using the parameters we estimated in the previous step, we now simulate some trees (let's say 100) under the same model, so we can see what kinds of trees that model produces:
```{r, results="hide", warning=FALSE, message=FALSE}
emptestsims <- GetMetricTreeSets(empirical_start=TRUE, empParams=emptestparams, current_method="BD", Numbsim1=100)
```

### 3.4 Get Metrics (and Parameters) of Simulated Trees ###
Now we get the tree metrics for our freshly simulated trees (we could alsouse `GetTreeParams` again to also estimate their parameters, but we'll save that for another day):
```{r, results="hide", warning=FALSE, message=FALSE}
simtestmetrics <- GetTreeMetrics(emptestsims, empirical_start=TRUE)
```

### 3.5 Compare Empirical and Simulated Tree Shapes ###
To compare how our simulations compare to the input tree, we can use the distribution of tree metrics to calculate a p-value for the empirical trees metrics:
```{r, results="hide"}
pvalues <- PvalMetrics(emptestmetrics, simtestmetrics)
```

### 3.6 Plot Results ###
For illustration and to get a better idea of what our results look like, we can plot them in a number of different ways.
```{r, fig.width=7, fig.height=3}
plotPvalMetricsPDF(emptestmetrics, simtestmetrics, set=1)
```
```{r, fig.width=5, fig.height=5}
ScatterMetrics(emptestmetrics, simtestmetrics, pair=1, skim=FALSE, colours=c("black", "red"))
```

##4 Final Notes##









## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output:
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side.

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
